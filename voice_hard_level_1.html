<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>16x16 Sudoku - Voice Command</title>
    <link href="[https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap](https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap)" rel="stylesheet" />
    <style>
      :root {
        --bg-color: #121212;
        --text-color: #e1e1e1;
        --fixed-text-color: #ffffff;
        --user-text-color: #64b5f6;
        --grid-border-color: #3a3a3c;
        --grid-thick-border-color: #9e9e9e;
        --selected-cell-bg: #2c3e50;
        --error-cell-bg: #cf6679;
        --button-bg: #1e1e1e;
        --button-hover-bg: #2c2c2e;
        --modal-bg: rgba(30, 30, 30, 0.95);
        --text-gray-color: #b0b0b0;
      }
      .light-mode {
        --bg-color: #ffffff;
        --text-color: #212121;
        --fixed-text-color: #000000;
        --user-text-color: #1976d2;
        --grid-border-color: #d1d1d6;
        --grid-thick-border-color: #333333;
        --selected-cell-bg: #bbdefb;
        --error-cell-bg: #e57373;
        --button-bg: #f5f5f5;
        --button-hover-bg: #e0e0e0;
        --modal-bg: rgba(245, 245, 245, 0.95);
        --text-gray-color: #6b7280;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: grid;
        place-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 1rem;
        box-sizing: border-box;
        overflow: hidden;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      .game-container { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
      h1 { font-size: 2rem; font-weight: 700; color: var(--text-color); margin-bottom: 0.5rem; text-align: center; }
      .sudoku-grid { 
          display: grid; 
          grid-template-columns: repeat(16, clamp(22px, 3.5vw, 38px)); 
          grid-template-rows: repeat(16, clamp(22px, 3.5vw, 38px)); 
          border: 3px solid var(--grid-thick-border-color); 
          border-radius: 8px; 
          overflow: hidden; 
          background-color: var(--button-bg);
      }
      .sudoku-cell {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: clamp(0.7rem, 1.5vw, 1.0rem);
        font-weight: 600;
        border: 1px solid var(--grid-border-color);
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s ease, color 0.2s ease;
      }
      .sudoku-cell:nth-child(4n) { border-right: 2px solid var(--grid-thick-border-color); }
      .sudoku-cell:nth-child(16n) { border-right: none; }
      .row-border { border-bottom: 2px solid var(--grid-thick-border-color); }
      
      .sudoku-cell::before {
        content: attr(data-label);
        position: absolute;
        top: 1px;
        left: 2px;
        font-size: 0.45rem;
        font-weight: 400;
        color: var(--text-gray-color);
      }
      .sudoku-cell.fixed::before { display: none; }
      .sudoku-cell.fixed { color: var(--fixed-text-color); cursor: default; }
      .sudoku-cell.user-filled { color: var(--user-text-color); font-weight: 700; }
      .sudoku-cell.selected { background-color: var(--selected-cell-bg) !important; }
      .sudoku-cell.error-shake { animation: shake 0.5s; background-color: var(--error-cell-bg); }
      @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

      #message-area { font-weight: bold; min-height: 48px; text-align: center; font-size: 1.2rem; order: -1; width: 100%; max-width: 600px; padding: 0.5rem; border-radius: 8px; background-color: var(--button-bg); }
      #voice-command-button { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 0.75rem 1.5rem; font-size: 1.1rem; font-weight: 700; border-radius: 0.75rem; border: none; cursor: pointer; transition: all 0.3s ease; }
      #voice-command-button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(99, 102, 241, 0.4); }
      #voice-command-button.listening { background: linear-gradient(135deg, #8b5cf6, #d946ef); animation: pulse 1.5s infinite; }
      @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

      .ui-buttons { position: fixed; top: 1rem; right: 1rem; z-index: 50; display: flex; gap: 0.5rem; }
      .ui-button { display: flex; align-items: center; justify-content: center; width: 3rem; height: 3rem; border-radius: 50%; cursor: pointer; border: 1px solid var(--grid-border-color); background-color: var(--button-bg); color: var(--text-color); }
      #back-button { position: fixed; top: 1rem; left: 1rem; z-index: 50; }
      .hidden { display: none; }
      
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: grid; place-items: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
      .modal-overlay.visible { opacity: 1; pointer-events: auto; }
      .modal-content { background-color: var(--modal-bg); backdrop-filter: blur(10px); padding: 2rem; border-radius: 16px; width: 90%; max-width: 500px; border: 1px solid var(--grid-border-color); position: relative; }
      .modal-content h2, h3 { font-weight: 700; color: var(--text-color); margin: 0 0 1.5rem 0; padding-bottom: 0.5rem; border-bottom: 2px solid var(--grid-thick-border-color); }
      .modal-content ul { padding-left: 1.25rem; }
      .modal-content li { margin-bottom: 1rem; }
      .modal-content code { background-color: var(--button-hover-bg); padding: 0.2rem 0.4rem; border-radius: 4px; font-weight: bold; }
      .close-modal { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 2rem; line-height: 1; cursor: pointer; color: var(--text-color); }

      /* --- CONFIRMATION MODAL STYLES (for Back Button) --- */
      #confirmation-modal .modal-content { padding: 1.5rem; max-width: 400px; }
      #confirmation-modal h2 { font-size: 1.25rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--grid-border-color); }
      #confirmation-modal p { margin-bottom: 1.5rem; line-height: 1.6; }
      #confirmation-modal .flex { display: flex; }
      #confirmation-modal .justify-end { justify-content: flex-end; }
      #confirmation-modal .space-x-4 > * + * { margin-left: 1rem; }
      #confirmation-modal button { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s ease; cursor:pointer; }
      #confirm-cancel-button { border: 1px solid var(--grid-border-color); color: var(--text-color); background-color: transparent; }
      #confirm-ok-button { background-color: #ef4444; color: white; border: none;}
      #confirm-ok-button:hover { background-color: #dc2626; }
      
      /* --- CELEBRATION ANIMATION STYLES --- */
      #celebration-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; display: none; place-items: center; overflow: hidden; }
      #celebration-overlay.active { display: grid; }
      #celebration-text { font-family: 'Inter', sans-serif; font-size: clamp(2.5rem, 10vw, 5rem); font-weight: 900; color: #ffcc00; text-shadow: 0 0 10px rgba(255, 165, 0, 0.8), 0 0 20px rgba(255, 69, 0, 0.6); animation: pulseScale 0.5s ease-out forwards; opacity: 0; transform: scale(0.5); z-index: 1; }
      @keyframes pulseScale { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
      .confetti { position: absolute; width: 10px; height: 10px; background-color: #fff; opacity: 0; border-radius: 50%; animation: confetti-fall 2.5s ease-in forwards; }
      .star { position: absolute; font-size: 20px; color: #ffd700; opacity: 0; animation: star-burst 2.5s ease-out forwards; transform: rotate(45deg); }
      @keyframes confetti-fall { 0% { transform: translateY(-50vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
      @keyframes star-burst { 0% { transform: scale(1) translateY(0); opacity: 1; } 100% { transform: scale(0.5) translateY(-50vh); opacity: 0; } }
    </style>
  </head>
  <body>
    <button id="back-button" class="ui-button" aria-label="Go back" title="Go back">
        <svg style="width: 1.5rem; height: 1.5rem" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
    </button>
    <div class="ui-buttons">
      <button id="rules-button" class="ui-button" aria-label="Show rules" title="Show rules">
        <svg style="width: 1.5rem; height: 1.5rem" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z"/></svg>
      </button>
      <button id="theme-toggle" class="ui-button" aria-label="Toggle theme" title="Toggle theme">
        <svg id="sun-icon" class="hidden" style="width: 1.5rem; height: 1.5rem" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
        <svg id="moon-icon" class="hidden" style="width: 1.5rem; height: 1.5rem" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
      </button>
    </div>

    <main>
      <div class="game-container" role="application">
        <h1 id="game-title">16x16 Sudoku Voice <br> Hard - Level 1</h1>
        <div id="message-area" role="status" aria-live="polite">Click the button to start.</div>
        <div id="sudoku-grid" class="sudoku-grid" aria-label="16 by 16 puzzle grid"></div>
        <div class="controls-wrapper">
          <button id="voice-command-button">Start Voice Command</button>
        </div>
      </div>
    </main>

    <div id="rules-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-rules-modal" class="close-modal">&times;</button>
            <h2>16x16 Voice Sudoku Rules</h2>
            <ul>
                <li><strong>Objective:</strong> Fill the 16x16 grid so that each row, column, and 4x4 box contains the numbers **1 through 16** exactly once.</li>
                <li><strong>Select a Cell:</strong> Click the voice button and say the cell's coordinates, like <code>Alpha 1</code>, <code>C 4</code>, or <code>Papa 16</code>.</li>
                <li><strong>Place a Value:</strong> Once a cell is selected, click the button again and say the number you want to place (e.g., <code>Five</code>, <code>9</code>, <code>Thirteen</code>, or <code>Sixteen</code>).</li>
                <li><strong>Clear a Cell:</strong> To clear a cell, select it and then say <code>Clear</code> or <code>Erase</code>.</li>
            </ul>
        </div>
    </div>
    
    <div id="completion-options-modal" class="modal-overlay">
      <div class="modal-content text-center">
        <h2 class="text-3xl font-extrabold" style="color: #4ade80; margin-bottom: 1rem;">Level Complete!</h2>
        <p class="text-lg mb-6">Congratulations! Ready for the next challenge?</p>
        
        <div class="space-y-4">
          <button id="next-level-button" style="width: 100%; padding: 0.75rem 1.5rem; border-radius: 0.75rem; background-color: #4f46e5; color: white; font-weight: bold; border: none; cursor: pointer;">
            Next Level (Hard - 2)
          </button>
          <button id="back-to-levels-button" style="width: 100%; padding: 0.75rem 1.5rem; border-radius: 0.75rem; background-color: #4b5563; color: white; font-weight: bold; border: none; cursor: pointer;">
            Back to Level Select
          </button>
        </div>
      </div>
    </div>
    
    <div id="confirmation-modal" class="modal-overlay">
      <div class="modal-content">
        <h2 id="confirmation-title" style="color: var(--error-cell-bg);">Confirm Navigation</h2>
        <p id="confirmation-message">Leaving will mark this level as **Dropped** and clear your progress.</p>
        <div class="flex justify-end space-x-4">
          <button id="confirm-cancel-button">Cancel</button>
          <button id="confirm-ok-button" style="background-color: var(--error-cell-bg); color: white; border: none;">Leave & Drop</button>
        </div>
      </div>
    </div>

    <div id="celebration-overlay">
        <div id="celebration-text">CONGRATULATIONS!</div>
    </div>

    <script>
      "use strict";

      // --- START PROFILE STATS PLACEHOLDERS ---
      async function fetchStatsFromServer() { console.warn("fetchStatsFromServer: Placeholder."); const d=localStorage.getItem('userStats'); return d?JSON.parse(d):{normal:{easy:{completed:0,dropped:0},medium:{completed:0,dropped:0},hard:{completed:0,dropped:0},training:{completed:0,dropped:0}},voice:{easy:{completed:0,dropped:0},medium:{completed:0,dropped:0},hard:{completed:0,dropped:0},training:{completed:0,dropped:0}}}; }
      async function updateStatOnServer(mode, difficulty, levelIndex, status) { 
          console.warn(`updateStatOnServer: Simulating update for ${mode} ${difficulty} L${levelIndex} -> ${status}.`);
          try {
            const stats = await fetchStatsFromServer();
            stats[mode] = stats[mode] || {};
            stats[mode][difficulty] = stats[mode][difficulty] || {completed:0,dropped:0};
            const targetStats = stats[mode][difficulty];
            if (status === 'completed') targetStats.completed++;
            if (status === 'dropped') targetStats.dropped++;
            localStorage.setItem('userStats', JSON.stringify(stats));
          } catch (e) { /* ignore */ }
          return true; 
      }
      // --- END PROFILE STATS PLACEHOLDERS ---

      document.addEventListener("DOMContentLoaded", () => {
        const body = document.body;
        const gridElement = document.getElementById("sudoku-grid");
        const messageArea = document.getElementById("message-area");
        const voiceButton = document.getElementById("voice-command-button");
        const rulesButton = document.getElementById("rules-button");
        const rulesModal = document.getElementById("rules-modal");
        const closeRulesModal = document.getElementById("close-rules-modal");
        const backButton = document.getElementById("back-button");
        const completionModal = document.getElementById('completion-options-modal');
        const nextLevelButton = document.getElementById('next-level-button');
        const backToLevelsButton = document.getElementById('back-to-levels-button');
        const confirmationModal = document.getElementById('confirmation-modal');
        const celebrationOverlay = document.getElementById('celebration-overlay');
        const confettiColors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];

        // --- UI & THEME LOGIC ---
        rulesButton.addEventListener("click", () => rulesModal.classList.add("visible"));
        closeRulesModal.addEventListener("click", () => rulesModal.classList.remove("visible"));
        rulesModal.addEventListener("click", (e) => { if(e.target === rulesModal) rulesModal.classList.remove("visible"); });
        
        const applyTheme = (theme) => {
          localStorage.setItem('theme', theme);
          body.classList.toggle("light-mode", theme === "light");
          document.getElementById("sun-icon").classList.toggle("hidden", theme === "dark");
          document.getElementById("moon-icon").classList.toggle("hidden", theme === "light");
        };
        document.getElementById("theme-toggle").addEventListener("click", () => applyTheme(body.classList.contains("light-mode") ? "dark" : "light"));
        applyTheme(localStorage.getItem('theme') || (window.matchMedia?.("(prefers-color-scheme: dark)").matches ? "dark" : "light"));
        
        // --- ANIMATION LOGIC ---
        function runCelebration() {
            const numParticles = 30;
            celebrationOverlay.classList.add('active');
            for (let i = 0; i < numParticles; i++) {
                const particle = document.createElement('div'); const isStar = Math.random() > 0.5;
                particle.className = isStar ? 'star' : 'confetti';
                particle.style.left = `${Math.random() * 100}vw`;
                particle.style.top = `${Math.random() * 100}vh`;
                if (isStar) {
                  particle.textContent = '⭐';
                  particle.style.animationDuration = `${1.5 + Math.random() * 1}s`;
                  particle.style.animationDelay = `${Math.random() * 0.5}s`;
                } else {
                  particle.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                  particle.style.width = `${5 + Math.random() * 10}px`;
                  particle.style.height = `${5 + Math.random() * 10}px`;
                  particle.style.animationDuration = `${1.8 + Math.random() * 0.5}s`;
                  particle.style.animationDelay = `${Math.random() * 0.5}s`;
                }
                celebrationOverlay.appendChild(particle);
                setTimeout(() => { particle.remove(); }, 2500);
            }
            setTimeout(() => { celebrationOverlay.classList.remove('active'); }, 2500);
        }

        // --- CONFIRMATION MODAL FUNCTION ---
        function showConfirmationModal(message, onOk, onCancel) {
            document.getElementById('confirmation-message').textContent = message;
            const okOld = document.getElementById('confirm-ok-button');
            const cancelOld = document.getElementById('confirm-cancel-button');
            const okNew = okOld.cloneNode(true);
            const cancelNew = cancelOld.cloneNode(true);
            okOld.parentNode.replaceChild(okNew, okOld);
            cancelOld.parentNode.replaceChild(cancelNew, cancelOld);

            okNew.addEventListener('click', () => {
                confirmationModal.classList.remove('visible');
                if (onOk) onOk();
            });
            cancelNew.addEventListener('click', () => {
                confirmationModal.classList.remove('visible');
                if (onCancel) onCancel();
            });
            confirmationModal.classList.add('visible');
        }

        // --- GAME STATE & CONSTANTS (16x16 Hard Level 1) ---
        const GRID_SIZE = 16;
        const DIFFICULTY_MODE = 'voice'; 
        const DIFFICULTY_LEVEL = 'hard'; 
        const LEVEL_INDEX = 1; // *** UPDATED LEVEL INDEX ***
        let currentGrid = [], originalGrid = [], solutionGrid = [];
        let selectedCell = null;
        let labelToCellMap = {};
        const deepCopyGrid = (g) => g.map((r) => [...r]);

        // *** HARD 16x16 PUZZLE ***
        const fixedPuzzle = [
            [11, 5, 0, 0, 0, 13, 1, 0, 0, 2, 0, 10, 0, 0, 4, 15], [1, 0, 2, 0, 0, 15, 0, 5, 0, 12, 11, 0, 6, 8, 0, 0], [0, 15, 12, 10, 0, 0, 0, 6, 0, 1, 0, 0, 0, 0, 0, 11], [0, 0, 0, 6, 2, 0, 11, 0, 0, 0, 0, 0, 16, 0, 5, 12],
            [12, 0, 0, 0, 0, 1, 16, 11, 6, 0, 0, 0, 0, 9, 0, 10], [2, 0, 0, 1, 12, 0, 3, 0, 15, 0, 10, 13, 0, 0, 0, 0], [0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 9, 0, 0, 1, 15, 0], [14, 0, 15, 0, 10, 0, 9, 0, 0, 0, 0, 0, 11, 0, 0, 4],
            [5, 0, 0, 11, 0, 0, 0, 0, 0, 13, 0, 16, 0, 7, 0, 6], [0, 1, 16, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 12, 0], [0, 0, 0, 0, 7, 11, 0, 1, 0, 10, 0, 6, 3, 0, 0, 13], [10, 0, 14, 0, 0, 0, 0, 12, 11, 16, 5, 0, 0, 0, 0, 9],
            [15, 11, 0, 5, 0, 0, 0, 0, 0, 14, 0, 1, 10, 0, 0, 0], [16, 0, 0, 0, 0, 0, 12, 0, 3, 0, 0, 0, 15, 11, 9, 0], [0, 0, 10, 3, 0, 14, 15, 0, 9, 0, 16, 0, 0, 5, 0, 1], [4, 12, 0, 0, 1, 0, 10, 0, 0, 5, 13, 0, 0, 0, 3, 7]
        ];

        const fixedSolution = [
            [11, 5, 8, 4, 13, 16, 1, 2, 7, 9, 6, 10, 14, 3, 4, 15], [1, 14, 2, 7, 3, 15, 4, 5, 8, 12, 11, 9, 6, 8, 13, 6], [3, 15, 12, 10, 9, 4, 7, 6, 14, 1, 13, 5, 2, 16, 8, 11], [16, 13, 4, 6, 2, 8, 11, 10, 12, 5, 3, 7, 1, 14, 5, 12],
            [12, 4, 1, 15, 5, 1, 16, 11, 6, 8, 7, 3, 13, 9, 2, 10], [2, 6, 13, 1, 12, 9, 3, 7, 15, 4, 10, 13, 8, 14, 16, 5], [7, 10, 5, 8, 14, 3, 2, 13, 1, 11, 9, 15, 4, 1, 15, 16], [14, 9, 15, 16, 10, 7, 9, 4, 5, 3, 2, 12, 11, 6, 1, 4],
            [5, 3, 7, 11, 4, 2, 8, 15, 10, 13, 1, 16, 9, 7, 14, 6], [9, 1, 16, 2, 13, 10, 5, 14, 7, 6, 4, 8, 12, 15, 12, 3], [8, 14, 11, 12, 7, 11, 6, 1, 3, 10, 15, 6, 3, 2, 10, 13], [10, 16, 14, 9, 8, 5, 13, 12, 11, 16, 5, 4, 7, 1, 6, 9],
            [15, 11, 6, 5, 16, 12, 14, 8, 2, 14, 10, 1, 10, 4, 7, 2], [16, 2, 9, 13, 1, 6, 12, 3, 3, 7, 8, 14, 15, 11, 9, 5], [13, 8, 10, 3, 4, 14, 15, 9, 9, 2, 16, 11, 1, 5, 13, 1], [4, 12, 7, 1, 1, 10, 10, 16, 15, 5, 13, 2, 3, 12, 3, 7]
        ];


        // --- NAVIGATION FUNCTIONS ---
        function goToLevelSelect() { window.location.href = 'index.html'; }
        // *** NEXT LEVEL TARGET: Voice_Hard_level_2.html ***
        function goToNextLevel() { 
          window.location.href = `Voice_${DIFFICULTY_LEVEL.charAt(0).toUpperCase() + DIFFICULTY_LEVEL.slice(1)}_level_${LEVEL_INDEX + 1}.html`; 
        }

        // --- CORE GAME FUNCTIONS (UPDATED for 16x16) ---
        function newGame() {
          originalGrid = deepCopyGrid(fixedPuzzle);
          currentGrid = deepCopyGrid(fixedPuzzle);
          solutionGrid = deepCopyGrid(fixedSolution);
          renderGrid();
          completionModal.classList.remove('visible');
          messageArea.textContent = "Click the button to start.";
        }

        function isMoveValid(grid, row, col, num) {
          for (let i = 0; i < GRID_SIZE; i++) { if (grid[row][i] === num || grid[i][col] === num) return false; }
          const boxRowStart = Math.floor(row / 4) * 4;
          const boxColStart = Math.floor(col / 4) * 4;
          for (let r = 0; r < 4; r++) { for (let c = 0; c < 4; c++) { if (grid[boxRowStart + r][boxColStart + c] === num) return false; } }
          return true;
        }
        
        function generateLabel(row, col) {
            const rowChar = String.fromCharCode(65 + row);
            const colNum = col + 1;
            return rowChar + colNum;
        }

        function renderGrid() {
            gridElement.innerHTML = "";
            labelToCellMap = {};
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const cell = document.createElement("div");
                    cell.className = "sudoku-cell";
                    cell.dataset.row = r; cell.dataset.col = c;
                    if ((r + 1) % 4 === 0 && r < 15) cell.classList.add("row-border");
                    
                    const value = currentGrid[r][c];
                    const originalValue = originalGrid[r][c];
                    const label = generateLabel(r, c);
                    
                    cell.dataset.label = label;
                    labelToCellMap[label] = { r, c, element: cell };
                    cell.addEventListener("click", () => handleCellClick(cell));

                    if (originalValue !== 0) {
                        cell.textContent = originalValue;
                        cell.classList.add("fixed");
                    } else if (value !== 0) {
                        cell.textContent = value;
                        cell.classList.add("user-filled");
                    }
                    gridElement.appendChild(cell);
                }
            }
        }
        
        function handleCellClick(cell) {
            const isSameCell = selectedCell === cell;
            document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
            // NOTE: Highlighting logic is often omitted in larger grids for performance/clarity, using only 'selected'.
            if (isSameCell) {
                selectedCell = null;
                return;
            }
            selectedCell = cell;
            selectedCell.classList.add("selected");
        }

        function placeNumber(num) {
          if (!selectedCell || selectedCell.classList.contains('fixed')) return false;
          const row = parseInt(selectedCell.dataset.row), col = parseInt(selectedCell.dataset.col);
          const tempGrid = deepCopyGrid(currentGrid);
          tempGrid[row][col] = 0; 
          
          if (!isMoveValid(tempGrid, row, col, num)) {
            selectedCell.classList.add("error-shake");
            setTimeout(() => selectedCell.classList.remove("error-shake"), 500);
            return false;
          }
          currentGrid[row][col] = num;
          renderGrid(); 
          checkWinCondition();
          return true;
        }

        function clearCell() {
          if (!selectedCell || selectedCell.classList.contains('fixed')) return;
          const row = parseInt(selectedCell.dataset.row), col = parseInt(selectedCell.dataset.col);
          currentGrid[row][col] = 0;
          renderGrid(); 
        }
        
        function clearSelection() {
            if (selectedCell) {
                document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
                selectedCell = null;
            }
        }

        function checkWinCondition() {
            if (currentGrid.some(row => row.includes(0))) return;
            const isCorrect = JSON.stringify(currentGrid) === JSON.stringify(solutionGrid);
            
            if (isCorrect) {
                runCelebration();
                messageArea.textContent = "🎉 PUZZLE SOLVED! 🎉";
                voiceButton.disabled = true;
                clearSelection();
                
                updateStatOnServer(DIFFICULTY_MODE, DIFFICULTY_LEVEL, LEVEL_INDEX, 'completed');

                setTimeout(() => { 
                    nextLevelButton.textContent = `Next Level (Hard - ${LEVEL_INDEX + 1})`;
                    completionModal.classList.add('visible'); 
                }, 1200);
            }
        }

        // --- VOICE COMMAND LOGIC (UPDATED for 16x16) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            voiceButton.disabled = true;
            voiceButton.textContent = "Voice Not Supported";
            messageArea.textContent = "Sorry, your browser does not support voice commands.";
        } else {
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            let voiceState = 'idle';

            const speak = (text, callback) => {
                speechSynthesis.cancel();
                const utterance = new window.SpeechSynthesisUtterance(text);
                if(callback) utterance.onend = callback;
                window.speechSynthesis.speak(utterance);
            };

            const startListening = (state) => {
                if (completionModal.classList.contains('visible')) return;
                voiceState = state;
                voiceButton.classList.add('listening');
                voiceButton.textContent = "Listening...";
                try {
                    recognition.start();
                } catch(e) {
                    voiceButton.classList.remove('listening');
                    voiceButton.textContent = "Start Voice Command";
                }
            };
            
            voiceButton.addEventListener('click', () => {
                if (voiceState !== 'idle') return;
                if (selectedCell) {
                    speak("Say the number to place, from one to sixteen.", () => startListening('listening-for-number'));
                } else {
                    speak("Say the cell coordinates, like A one or P sixteen.", () => startListening('listening-for-cell'));
                }
            });
            
            // NATO Phonetic and Value Maps (Expanded for 16)
            const natoPhonetic = {'ALPHA':'A', 'BRAVO':'B', 'CHARLIE':'C', 'DELTA':'D', 'ECHO':'E', 'FOXTROT':'F', 'GOLF':'G', 'HOTEL':'H', 'INDIA':'I', 'JULIETT':'J', 'KILO':'K', 'LIMA':'L', 'MIKE':'M', 'NOVEMBER':'N', 'OSCAR':'O', 'PAPA':'P'};
            const valueMap = { "ONE": 1, "TWO": 2, "THREE": 3, "FOUR": 4, "FIVE": 5, "SIX": 6, "SEVEN": 7, "EIGHT": 8, "NINE": 9, "TEN": 10, "ELEVEN": 11, "TWELVE": 12, "THIRTEEN": 13, "FOURTEEN": 14, "FIFTEEN": 15, "SIXTEEN": 16, "TO": 2, "FOR": 4, "ATE": 8 };

            const parseCellCommand = (transcript) => {
                const words = transcript.toUpperCase().split(/\s+/);
                let foundLetter = null, foundNumber = null;
                
                for (const word of words) {
                    if (!foundLetter) {
                        const phoneticLetter = natoPhonetic[word];
                        if (phoneticLetter) {
                            foundLetter = phoneticLetter;
                        } else if (word.length === 1 && word >= 'A' && word <= 'P') {
                            foundLetter = word;
                        }
                    }
                    
                    const num = valueMap[word] || parseInt(word);
                    if (!foundNumber && num >= 1 && num <= 16) {
                        foundNumber = num;
                    }
                }
                
                if (foundLetter && foundNumber) {
                    const label = foundLetter + foundNumber;
                    return labelToCellMap[label] ? label : null;
                }
                return null;
            };

            const parseNumberCommand = (transcript) => {
                const words = transcript.toUpperCase().split(' ');
                for (const word of words) {
                    if (word === 'CLEAR' || word === 'ERASE') return 'clear';
                    const num = valueMap[word] || parseInt(word);
                    if (num >= 1 && num <= 16) return num;
                }
                return null;
            };
            
            recognition.onresult = (event) => {
                let transcript = event.results[0][0].transcript.trim();
                messageArea.textContent = `Heard: "${transcript}"`; 

                if (voiceState === 'listening-for-cell') {
                    const cellLabel = parseCellCommand(transcript);
                    if (cellLabel && labelToCellMap[cellLabel]) {
                        handleCellClick(labelToCellMap[cellLabel].element);
                        speak(`Cell ${cellLabel} selected.`);
                    } else {
                        speak(`Sorry, I didn't recognize that cell. Click to try again.`);
                    }
                } else if (voiceState === 'listening-for-number') {
                    const command = parseNumberCommand(transcript);
                    if (command === 'clear') {
                        clearCell();
                        speak("Cell cleared.", clearSelection);
                    } else if (command !== null) {
                        if (placeNumber(command)) {
                            speak(`Placed ${command}.`, clearSelection);
                        } else {
                            speak(`${command} is not a valid move here. Click to try again.`);
                        }
                    } else {
                        speak("Please say a number from 1 to 16, or say 'clear'. Click to try again.");
                    }
                }
            };
            
            recognition.onend = () => {
                voiceButton.classList.remove('listening');
                voiceButton.textContent = "Start Voice Command";
                voiceState = 'idle'; 
            };
            recognition.onerror = (event) => {
                messageArea.textContent = 'Error: ' + event.error;
                recognition.onend();
            };
        }
        
        // --- EVENT LISTENERS ---
        
        backButton.addEventListener("click", () => {
             showConfirmationModal(
                 "Leaving will mark this level as Dropped and clear your progress.",
                 () => { 
                     updateStatOnServer(DIFFICULTY_MODE, DIFFICULTY_LEVEL, LEVEL_INDEX, 'dropped').then(() => {
                         goToLevelSelect();
                     });
                 },
                 () => { /* cancelled */ }
             );
        });

        nextLevelButton.addEventListener('click', () => {
            completionModal.classList.remove('visible');
            goToNextLevel(); 
        });

        backToLevelsButton.addEventListener('click', () => {
            completionModal.classList.remove('visible');
            goToLevelSelect(); 
        });
        
        newGame();
      });
    </script>
  </body>
</html>